apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plex-media-server
spec:
  chart:
    spec:
      chart: plex-media-server
      sourceRef:
        kind: HelmRepository
        name: plex
        namespace: flux-system
      version: 0.8.0
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  interval: 5m
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - rachel
    image:
      tag: 1.41.3.9314-a0bfb8370
    ingress:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      enabled: true
      ingressClassName: nginx-external
      url: https://plex.denniseffing.de
    initContainer:
      script: |-
        #!/bin/sh
        echo "waiting for pre-existing pms database to uploaded..."

        if [ -d "/config/Library" ]; then
          echo "PMS library already exists, exiting."
          exit 0
        fi

        # wait for the database archive to be manually copied to the server
        while [ ! -f /pms.tgz ]; do sleep 2; done;

        tar -xvzf /pms.tgz -C /config
        rm pms.tgz

        echo "Done."
    extraVolumes:
      - name: tv-shows
        persistentVolumeClaim:
          claimName: tv-shows
      - name: movies
        persistentVolumeClaim:
          claimName: movies
      - name: music
        persistentVolumeClaim:
          claimName: music
    extraVolumeMounts:
      - name: tv-shows
        mountPath: "/mnt/NAS/TV Shows"
      - name: movies
        mountPath: "/mnt/NAS/Movies"
      - name: music
        mountPath: "/mnt/NAS/Music"
    pms:
      configStorage: 40Gi
      storageClassName: longhorn
